{% extends 'base.html' %}
{% block title %}Work Hour Calculator{% endblock %}
{% block content %}
  <div class="container-narrow">
    <div class="d-flex align-items-center justify-content-between mb-1">
      <h1 class="h4 m-0">Work Hour Calculator</h1>
      <span class="badge text-bg-primary hours-badge">Total: {{ '%.2f' % total_hours }} h</span>
    </div>
    <p class="text-muted mb-2">Showing data for your IP: <code>{{ current_ip }}</code></p>
    <div class="d-flex align-items-center gap-2 mb-4">
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('index', date=prev_date) }}">← Prev</a>
      <form class="d-flex align-items-center gap-2" method="get" action="{{ url_for('index') }}">
        <div class="input-group input-group-sm" style="width: 14rem;">
          <span class="input-group-text btn-like" data-action="open-picker" data-target="toolbar_date_display" data-picker="toolbar_date_picker" title="Pick date"><i class="bi bi-calendar-event"></i></span>
          <input class="form-control" type="text" id="toolbar_date_display" placeholder="DD-MM-YYYY" autocomplete="off" value="{{ selected_date[8:10] }}-{{ selected_date[5:7] }}-{{ selected_date[0:4] }}">
          <input type="hidden" name="date" id="toolbar_date_iso" value="{{ selected_date }}">
          <input type="date" id="toolbar_date_picker" class="picker-proxy" data-sync-to="toolbar_date_display" data-sync-iso="toolbar_date_iso">
        </div>
        <button class="btn btn-sm btn-primary" type="submit">Go</button>
      </form>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('index', date=next_date) }}">Next →</a>
      <div class="ms-auto"></div>
      {% if available_dates %}
      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          Jump to date
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          {% for d in available_dates %}
          <li><a class="dropdown-item" href="{{ url_for('index', date=d) }}">{{ d }}</a></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h5">Add Record</h2>
        <form method="POST" action="{{ url_for('add') }}" class="row g-2 align-items-end">
          <div class="col-auto">
            <label for="name" class="form-label">Name</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-person"></i></span>
              <input type="text" class="form-control name-input" id="name" name="name" required>
            </div>
          </div>
          <div class="col-auto">
            <label for="date_display" class="form-label">Date</label>
            <div class="input-group">
              <span class="input-group-text btn-like" data-action="open-picker" data-target="date_display" data-picker="date_picker" title="Pick date"><i class="bi bi-calendar-event"></i></span>
              <input type="text" class="form-control date-input" id="date_display" placeholder="DD-MM-YYYY" autocomplete="off" value="{{ selected_date[8:10] }}-{{ selected_date[5:7] }}-{{ selected_date[0:4] }}">
              <input type="hidden" id="date" name="date" value="{{ selected_date }}">
              <input type="date" id="date_picker" class="picker-proxy" data-sync-to="date_display" data-sync-iso="date">
            </div>
          </div>
          <div class="col-auto">
            <label for="start_time" class="form-label">Start</label>
            <div class="input-group">
              <span class="input-group-text btn-like" data-action="open-picker" data-target="start_time" data-picker="start_time_picker" title="Pick time"><i class="bi bi-clock"></i></span>
              <input type="text" class="form-control time-input" id="start_time" name="start_time" required pattern="\d{2}:\d{2}" placeholder="HH:MM" autocomplete="off">
              <input type="time" id="start_time_picker" data-sync-to="start_time" class="picker-proxy">
              <button type="button" class="btn btn-outline-secondary icon-btn" data-action="fill-now" data-target="start_time" title="Now"><i class="bi bi-lightning"></i></button>
            </div>
          </div>
          <div class="col-auto">
            <label for="end_time" class="form-label">End</label>
            <div class="input-group">
              <span class="input-group-text btn-like" data-action="open-picker" data-target="end_time" data-picker="end_time_picker" title="Pick time"><i class="bi bi-clock-history"></i></span>
              <input type="text" class="form-control time-input" id="end_time" name="end_time" required pattern="\d{2}:\d{2}" placeholder="HH:MM" autocomplete="off">
              <input type="time" id="end_time_picker" data-sync-to="end_time" class="picker-proxy">
              <button type="button" class="btn btn-outline-secondary icon-btn" data-action="fill-now" data-target="end_time" title="Now"><i class="bi bi-lightning"></i></button>
            </div>
          </div>
          <div class="col-auto">
            <label for="break_minutes" class="form-label">Break (minutes)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-cup-hot"></i></span>
              <input type="number" class="form-control break-input" id="break_minutes" name="break_minutes" value="0" min="0">
            </div>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary">Add</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h5 mb-3">Records</h2>
        {% if records %}
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Name</th>
                <th>Start</th>
                <th>End</th>
                <th>Break</th>
                <th>Hours</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for r in records %}
              <tr>
                <td>{{ r['name'] }}</td>
                <td>{{ r['start_time'] }}</td>
                <td>{{ r['end_time'] }}</td>
                <td>{{ r['break_minutes'] | int }} min</td>
                <td>{{ '%.2f' % r['worked_hours'] }}</td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('edit_form', record_id=r['id']) }}">Edit</a>
                  <form method="POST" action="{{ url_for('delete', record_id=r['id']) }}" style="display:inline" data-confirm-name="{{ r['name'] }}">
                    <input type="hidden" name="return_date" value="{{ selected_date }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="4" class="text-end">Total</th>
                <th>{{ '%.2f' % total_hours }}</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
        {% else %}
          <p class="text-muted mb-0">No records yet. Add your first entry above.</p>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
